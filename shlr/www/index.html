<html>
<head>
	<title>r2w2</title>
<!--
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
-->
	<link rel=Stylesheet href="style.css" type="text/css" />
	<meta name="viewport" content="width=340px, initial-scale=1" />
	<script src="script.js"></script>
<script>
function Ajax (method, uri, body, fn) {
        var x = new XMLHttpRequest ();
        x.open (method, uri, false);
        x.onreadystatechange = function (y) {
                if (fn) fn (x.responseText);
        }
        x.send (body);
}

function cmd(c, cb) {
	Ajax ('GET', "/cmd/"+c, '', function (x) {
		if (cb) cb (x);
		else {
			x = filter_asm (x);
			document.getElementById ('output').innerHTML = x;
		}
	});
}

function about() { cmd ("?V", function (version) { alert ("r2w v"+version); }); }

function panel_functions_load() {
	Ajax ('GET', "/cmd/afl", '', function (x) {
		var arr = x.split ("\n");
		x = ''
		for (var i in arr) {
			var line = arr[i].replace (/\s+/g,' ').split (' ');
			var addr = line[0];
			var name = line[3];
			if (!addr) continue;
			x += "<a onclick=\"cmd('pdr@"+addr+"')\">"+addr+"</a> "+name+"\n";
		}
		popup_show ("Functions", x);
		document.getElementById('output').innerHTML = x;
	});
}

var nl = "<br />";
var nl2 = "<br /><br />";
function show_popup_about () {
	var txt =
		"Display"+
		"<hr size=1/>"+
		"<a href=\"javascript:setmode(9\" />"+
		"<br /><br />"+
		"It runs on top of an embedded webserver in radare2. Here's some commands to try:"+nl2+
		"Display<br />"+
		"<br /><br />"+
		"<a href=\"/graph/\">graph demo</a>"+nl2+
		"";
	popup_show ("Options", txt);
}

function show_popup_commands () {
	var txt =
		"<h3>Choose</h3>"+
		"<a href=\"javascript:popup_hide();cmd('aa');\">full analyze</a><br />"+
		"<a href=\"javascript:popup_hide();cmd('af');\">analyze function</a><br />"+
		"<a href=\"javascript:popup_hide();cmd('afl');\">show functions</a><br />";
	popup_show ("Commands", txt);
}
function handleKeyPress(e, form) {
	var key = e.keyCode || e.which;
	if (key==13) {
		input_activate ();
	}
}

function seek(x) {
	cmd ("s "+x, function (x) {
		cmd ("pd");
		window.scrollTo (0,0);
	});
}

var curoff = 0;
var lastoff = 0;
var display = "pd";

function less () {
	cmd ("b", function (block) {
		cmd ("s "+curoff+"-"+block+";"+display, function (x) {
			x = filter_asm (x);
			var body = document.getElementById('output').innerHTML;
			document.getElementById('output').innerHTML = x + body;
		});
	});
}
function more () {
	cmd ("?v $l @ "+lastoff, function (oplen) {
		cmd (display+" @ "+lastoff+"+"+oplen, function (x) {
			x = filter_asm (x);
			document.getElementById('output').innerHTML += x;
		});
	});
}

function filter_asm(x) {
	var lines = x.split (/\n/g);
	cmd ("s", function (x) { curoff = x; });
	for (var i=lines.length-1;i>0;i--)  {
		var a = lines[i].match (/0x([a-fA-F0-9]*)/);
		if (a && a.length>0) {
			lastoff = a[0].replace (/:/g, "");
			break;
		}
	}

	x = x.replace (/0x([a-zA-Z0-9]*)/g, "<a href='javascript:seek(\"0x$1\")'>0x$1</a>");
	x = x.replace (/fcn.(.*)/g, "<a href='javascript:seek(\"fcn.$1\")'>fcn.$1</a>");
	x = x.replace (/loc.(.*)/g, "<a href='javascript:seek(\"loc.$1\")'>loc.$1</a>");
	x = x.replace (/call/g, "<b style='color:green'>call</b>");
	x = x.replace (/(jmp|jnz|jg|je|jl|jz)/g, "<b style='color:green'>$1</b>");
	x = x.replace (/ret/g, "<b style='color:red'>ret</b>");
	x = x.replace (/(push|pop)/g, "<b style='color:magenta'>$1</b>");
	x = x.replace (/mov/g, "<b style='color:yellow'>mov</b>");
	x = x.replace (/(test|cmp)/g, "<b style='color:green'>$1</b>");
	x = x.replace (/nop/g, "<b style='color:blue'>nop</b>");
	return x;
}

function input_activate () {
	var txt = document.getElementById('input').value;
	if (txt.length == 0) show_popup_commands (); else
	Ajax ('GET', '/cmd/'+txt, '', function (x) {
		x = filter_asm (x);
		document.getElementById('output').innerHTML = x;
		document.getElementById('input').value = '';
	});
}

function css(selector, property, value) {
	for (var i=0; i<document.styleSheets.length;i++) {
		try {
			document.styleSheets[i].insertRule (
				selector+ ' {'+property+':'+value+'}',
				document.styleSheets[i].cssRules.length);
		} catch (err) {
			try {
				document.styleSheets[i].addRule(
					selector, property+':'+value);
			} catch(err) {}
		}
	}
}

window.onorientationchange = function() {
	var header = document.getElementById ('header');
	var orientation = window.orientation;
	switch (orientation) {
	case 0:
		css ('.header', 'width', '220px');
		css ('input', 'width', '190px');
		css ('.console', 'width', '320px');
		document.body.setAttribute ("class","portrait");
		break; 
	case -90: 
	case 90:
		css ('.header', 'width', '480');
		css ('input', 'width', '360');
		css ('.console', 'width', '470');
		document.body.setAttribute("class","landscape");
		break;
	}
}

function popup_hide () {
	var p = document.getElementById ("popup");
	var b = document.getElementById ("popup_background");
	p.style.visibility="hidden";
	b.style.visibility="hidden";
}

function popup_show (title, body) {
	var p = document.getElementById ("popup");
	var t = document.getElementById ("popup_title");
	var c = document.getElementById ("popup_content");
	var b = document.getElementById ("popup_background");
	window.scrollTo(0,0);
	if (body) {
		p.style.visibility="visible";
		c.innerHTML = body;
		b.style.visibility="visible";
	}
	if (title) {
		t.innerHTML = title;
	}
	b.height =100;
}

function init() {
	var input = document.getElementById ('input');
	input.addEventListener ("activate", function (x) {
		input_activate();
	}, false);
	cmd (display);
}

</script>
</head>
<body onload="init()">
<div class=popup_background id="popup_background"
style="visibility:hidden"></div>

<div id="popup" style="visibility:hidden">
<table class=popup >
<tr>
	<td style="text-align:left; width:100%">
	<div class=popup_title id="popup_title">
	Welcome to r2w2
	</div>
</td><td style="text-align:right">
	<input type="button" class="button" value="x" onclick="popup_hide()">
	</td>
</tr>
<tr>
	<td colspan=2 valign="top" style="light">
<div class="popup_content" id="popup_content">
This is the r2w2 ui. A rewrite in pure C/js of the original r2w written in python.
<br /><br />
This interface aims to run on every modern browser; from Android/iPhone/iPad to desktop browsers (Chromium, Firefox, ..)
<br /><br />
The UI is under heavy development. This is the first release and there will probably be lot of bugs and caveats. Feel free to report on <a href="http://github.com/radare/radare2">github</a> patches, ideas or bug reports.
<br /><br />
Enjoy!
	</div>
	</td>
</tr>
</table>
</div>

<div style="position:fixed; top:0px;left:0px;background-color:red;border:0px">
<table class=header>
<tr>
	<td style="text-align:left;vertical-align:top">
	<a href="javascript:show_popup_about ()"><img border=0 src="rlogo2.png" /></a>
</td> <td align="right" style="width:100%">
	<input style="width:100%" onkeypress="handleKeyPress(event)" id="input">
</td> </tr> 
</table>

</div>

<div class="console" style="top:25px !important; position:absolute;z-index:-99">
	<a href='javascript:less()'>... less</a>
<p id="output"></p>
	<a href='javascript:more()'>... more</a>
</div>
</body>
</html>


#!/bin/sh
# pancake / nopcode.org
# TODO: execute in this way? rasc -s $bytes -X
# TODO: use rasm2 instead of gas

[ -z "${ARCH}" ] && ARCH=`rarc2 -A`
[ -z "${CC}" ] && CC=gcc

compile() {
	spp -h >/dev/null 2>&1
	if [ $? = 0 ]; then
		spp -Darch=${ARCH} $@ | rarc2 -s -a${ARCH} > .a.S || exit $?
	else
		rarc2 -s -a${ARCH} $@ > .a.S || exit $?
	fi
}

help() {
	cat << EOF
Usage: rarc2-tool [-flag] [file]
   -b  dump bytes
   -x  execute
   -c  compile against libc
   -S  only generate .S file
ARCH: environ to set architecture: arm, x86, x64
EOF
	exit 1
}

while getopts bSxc o ; do
	[ "$o" = "?" ] && help
	eval $o=1
done

shift $((${OPTIND}-1))

if [ -n "`echo $@`" ]; then
	compile $@
	if [ -n "$c" ]; then
		${CC} .a.S -o .a.out
	else
		${CC} -nostdlib .a.S -o .a.out
	fi
	if [ -e .a.out ]; then
		if [ -n "$b" ]; then
			rabin2 -O d/S/.text .a.out
		else
			if [ -n "$x" ]; then
				./.a.out
			else
				cp .a.out $1.out
			fi
		fi
	fi
	rm -f .a.S .a.out
else
	help
fi
